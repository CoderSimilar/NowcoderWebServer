# 端口

## 简介

> "端口”是英文 port 的意译，可以认为是设备与外界通讯交流的出口。端口可分为虚拟端口和物理端口，其中虚拟端口指计算机内部或交换机路由器内的端口，不可见，是特指TCP/IP协议中的端口，是逻辑意义上的端口。例如计算机中的 80 端口、21 端口、23 端口等。物理端口又称为接口，是可见端口，计算机背板的 RJ45网口，交换机路由器集线器等 R/45 端口。电话使用 RJ11 插口也属于物理端口的范畴。
> 
> 如果把 IP 地址比作一间房子，端口就是出入这间房子的门。喜正的房子只有几个门，但是一个IP 地址的端口可以有 65536(即: 2^16)个之多! 端口是通过端口号来标记的，端口号只有整数，范围是从0到65535 (2^16-1)。
>
> 端口在计算机中是虚拟的，其相当于一个内核缓冲区。标识缓冲区需要端口号。端口号是标识计算机中进程的唯一编号，计算机中不能存在同样端口号的进程。有了端口号我们就知道要给哪一个进程发送信息。（不能采用进程号，因为进程号是时刻在变化的）
>
> 一个应用程序可以有多个端口。

## 端口类型

* 1，周知端口（Well Known Posts）

    周知端口是众所周知的端口号，也叫知名端口、公认端口或者常用端口，范围从 0 到 1023，它们紧密绑定于一些特定的服务。例如 80 端口分配给 WWW 服务，21 端口分配给 FTP 服务，23 端口分配给 Telnet 服务等等。我们在 IE 的地址栏里输入一个网址的时候是不必指定端口号的，因为在默认情况下 WWW 服务的端口是“80"。网络服务是可以使用其他端口号的，如果不是默认的端口号则应该在地址栏上指定端口号，方法是在地址后面加上冒号 " : " (半角)，再加上端口号。比如使用"8080"作为 WWW 服务的端口，则需要在地址栏里输入“网址:8080”。但是有些系统协议使用固定的端口号，它是不能被改变的，比如 139 端口专门用于 NetBIOS 与TCP/IP 之间的通信，不能手动改变。

* 2，注册端口（Registered Ports）

    端口号从 1024 到 49151，它们松散地绑定于一些服务，分配给用户进程或应用程序，这些进程主要是用户选择安装的一些应用程序，而不是已经分配好了公认端口的常用程序。这些端口在没有被服务器资源占用的时候，可以用用户端动态选用为源端口。

* 3.动态端口/私有端口 (Dynamic Ports / Private Ports)
  
    动态端口的范围是从 49152到 65535。之所以称为动态端口，是因为它一般不固定分配某种服务，而是动态分配。

# 网络模型

## OSI七层参考模型

> 七层模型，亦称 OSI (Open System lnterconnection) 参考模型，即开放式系统互联。参考模型是国际标准化组织(ISO)制定的一个用于计算机或通信系统间互联的标准体系，一般称为 OSI 参考模型或七层模型。
> 
> 它是一个七层的、抽象的模型体，不仅包括一系列抽象的术语或概念，也包括具体的协议。
>
|OSI参考模型|各层的解释|
|---|---|
|应用层|为应用程序提供服务|
|表示层|数据格式转化，数据加密|
|会话层|建立、管理和维护会话|
|传输层|建立、管理和维护端到端的连接|
|网络层|IP选址以及路由选择|
|数据链路层|提供介质访问和链路管理|
|物理层|物理层|

* 1，物理层: 主要定义物理设备标准，如网线的接口类型、光纤的接口类型、各种传输介质的传输速率等。它的主要作用是传输比特流(就是由1、0转化为电流强弱来进行传输，到达目的地后再转化为1、0。也就是我们常说的数模转换与模数转换)。这一层的数据叫做比特。

* 2，数据链路层: 建立逻辑连接、进行硬件地址寻址、差错校验等功能。定义了如何让格式化数据以帧为单位进行传输，以及如何让控制对物理介质的访问。将比特组合成字节进而组合成帧，用MAC地址访问介质。

* 3，网络层: 进行逻辑地址寻址，在位于不同地理位置的网络中的两个主机系统之间提供连接和路径选择。Internet的发展使得从世界各站点访问信息的用户数大大增加，而网络层正是管理这种连接的层。

* 4，传输层: 定义了一些传输数据的协议和端口号 (WWW 端口 80 等)，如: TCP(传输控制协议，传输效率低，可靠性强，用于传输可靠性要求高，数据量大的数据)，UDP (用户数据报协议，与TCP 特性恰恰相反，用于传输可靠性要求不高，数据量小的数据，如 QQ 聊天数据就是通过这种方式传输的)。 主要是将从下层接收的数据进行分段和传输，到达目的地址后再进行重组。常常把这一层数据叫做段。

* 5，会话层: 通过传输层(端口号:传输端口与接收端口)建立数据传输的通路。主要在你的系统之间发起会话或者接受会话请求。

* 6，表示层: 数据的表示、安全、压缩。主要是进行对接收的数据进行解释、加密与解密、压缩与解压缩等。也就是把计算机能够识别的东西转换成人能够能识别的东西(如图片、声音等)。

* 7，应用层: 网络服务与最终用户的一个接口。这一层为用户的应用程序(例如电子邮件、文件传输和终端仿真)提供网络服务。

## TCP/IP四层模型

### 简介

> 现在 Internet (因特网) 使用的主流协议族是 TCP/IP 协议族。它是一个分层、多协议的通信体系。TCP/IP协议族是一个四层协议系统，自底而上分别是数据链路层、网绍层、传输层和应用层。每一层完成不同的功能，且通过若干协议来实现，上层协议使用下层协议提供的服务。

|层|主要协议|
|---|---|
| 应用层 | ping、telnet、OSPF、DNS |
| 传输层 | TCP、UDP |
| 网络 | ICMP、IP |
| 数据链路层 | ARP、Data Link、RARP |

TCP/IP 协议在一定程度上参考了 OSI 的体系结构。OSI模型共有七层，从下到上分别是物理层、数据链路层、网络层、传输层、会话层、表示层和应用层。但是这显然是有些复杂的，所以在 TCP/IP 协议中，它们被简化为了四个层次。
* （1）应用层、表示层、会话层三个层次提供的服务相差不是很大，所以在 TCP/IP 协议中，它们被合并为应用层一个层次。
* （2）由于传输层和网络层在网络协议中的地位十分重要，所以在 TCP/IP 协议中它们被作为独立的两个层次.
* （3）因为数据链路层和物理层的内容相差不多，所以在 TCP/IP 协议中它们被归并在网络接口层一个层次里。

只有四层体系结构的 TCP/IP 协议，与有七层体系结构的 OSI 相比要简单了不少，也正是这样，TCP/IP 协议在实际的应用中效率更高，成本更低。

### 四层介绍

* 1，应用层: 应用层是TCP/IP 协议的第一层，是直接为应用进程提供服务的。
  * (1)对不同种类的应用程序它们会根据自己的需要来便用应用层的不同协议，邮件传输应用使用了 SMTP 协议、万维网应用便用了 HTTP 协议、远程登录服务应用使用了有 TELNET 协议
  * (2)应用层还能加密、解密、格式化数据。
  * (3)应用层可以建立或解除与其他节点的联系，这样可以充分节省网络资源
* 2，传输层: 作为 TCP/IP 协议的第二层，运输层在整个TCP/IP 协议中起到了中流砥柱的作用。且在运输层中 TCP 和 UDP 也同样起到了中流砥柱的作用。
* 3，网络层: 网络层在TCP/IP 协议中的位于第三层。在TP/IP 协议中网络层可以进行网络连接的建立和终止以及IP 地址的寻找等功能。
* 4，网络接口层: 在TCP/IP 协议中，网络接口层位于第四层。由于网络接口层兼并了物理层和数据链路层所以，网络接口层既是传输数据的物理媒介，也可以为网络层提供一条准确无误的线路。

# 协议

## 简介

> 协议，网络协议的简称，网络协议是通信计算机双方必须共同道从的一组约定。如怎么样建立连接、怎么样互相识别等。只有遵守这个约定，计算机之间才能相互通信交流。它的三要素是:语法、语义、时序。为了使数据在网络上从源到达目的，网络通信的参与方必须遵循相同的规则，这套规则称为协议(protocol)，它最终体现为在网络上传输的数据包的格式。
> 
> 协议往往分成几个层次进行定义，分层定义是为了使某一层协议的改变不影响其他层次的协议。

## 常见协议

应用层常见的协议有: FTP协议 (File Transfer Protocol文件传输协议) 、HTTP协议(Hyper Text TransferProtocol 超文本传输协议) 、NFS(Network File System 网络文件系统)。

传输层常见协议有: TCP协议 (Transmission Control Protocol传输控制协议) 、UDP协议(User DatagramProtocol 用户数据报协议)。

网络层常见协议有: IP协议 (Internet Protocol因特网互联协议) 、ICMP协议 (Internet Control MessageProtocol 因特网控制报文协议)、IGMP协议 (Internet Group Management Protocol 因特网组管理协议)

网络接口层常见协议有: ARP协议 (Address Resolution Protocol 地址解析协议)、RARP协议 (ReverseAddress Resolution Protocol 反向地址解析协议)。

## UDP协议

UDP协议由 8 字节的UDP数据头和要发送的数据组成。其中 8 字节的数据头包括：

| 16位源端口号 | 16位目的端口号 | 16位UDP长度 | 16位UDP校验和 |

* 1，源端口号: 发送方端口号
* 2，目的端口号: 接收方端口号
* 3，长度: UDP用户数据报的长度，最小值是8 (仅有首部)
* 4，校验和: 检测UDP用户数据报在传输中是否有错，有错就丢弃

## TCP协议

TCP协议由 20 ~ 60字节的TCP头部和要发送的数据组成，其中TCP头部数据包括：

｜ 16位源端口号 | 16位目的端口号 | 32位序号 | 32位确认号 | 4位头部长度 | 6位保留 | URG | ACK | PSH | RST | SYN | FIN | 16位窗口大小 | 16位校验和 | 16位紧急指针 | 其他选项（最多40字节）|

* 1，源端口号: 发送方端口号

* 2，目的端口号: 接收方端口号

* 3，序列号: 本报文段的数据的第一个字节的序号

* 4，确认序号: 期望收到对方下一个报文段的第一个数据字节的序号
  
* 5，首部长度(数据偏移): TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远，* 即首部长度。单位: 32位，即以 4字节为计算单位。
  
* 6，保留: 占6 位，保留为今后使用，目前应置为 `0`
  
* 7，紧急 `URG`: 此位置1，表明紧急指针字段有效，它告诉系统此报文段中有紧急数据，* 应尽快传送。
  
* 8，确认 `ACK`: 仅当 `ACK=1` 时确认号字段才有效，TCP 规定，在连接建立后所有传* 达的报文段都必须把 `ACK` 置 `1`。
  
* 9，推送 `PSH`: 当两个应用进程进行交互式的通信时，有时在一端的应用进程希望在键* 入一个命令后立即就能够收到对方的响应。在这种情况下，TCP 就可以使用推送(push) * 操作，这时，发送方 TCP 把 `PSH` 置 1，并立即创建一个报文段发送出去，接收方收* 到 `PSH = 1` 的报文段，就尽快地(即“推送”向前)交付给接收应用进程，而不再等到整* 个缓存都填满后再向上交付
  
* 10，复位 RST: 用于复位相应的 TCP 连接
  
* 11，同步 SYN: 仅在三次握手建立TCP 连接时有效、当`SYN = 1`而`ACK = 0`时，表明* 这是一个连接请求报文段对方若同意建立连接，则应在相应的报文段中使用 `SYN = 1`和* `ACK = 1`，因此，`SYN` 置 `1` 就表示这是一个连接请求或连接接受报文
  
* 12，终止 FIN: 用来释放一个连接。当 FIN =1 时，表明此报文段的发送方的数据已经* 发送完毕，并要求释放运输连接
  
* 13，窗口: 指发送本报文段的一方的接收窗口 (而不是自己的发送窗口)
  
* 14，校验和: 校验和字段检验的范围包括首部和数据两部分，在计算校验和时需要加上 12 字节的伪头部
  
* 15，紧急指针: 仅在 URG =1时才有意义，它指出本报文段中的紧急数据的字节数(紧急* 数据结束后就是普通数据)，即指出了紧急数据的末尾在报文中的位置，注意: 即使窗口* 为零时也可发送紧急数据
  
* 16，选项: 长度可变最长可达 40 字节当没有使用选项时CP 首部长度是 20 字节

## IP协议

IP协议由 20 ~ 60 字节的TCP头部和要发送的数据组成，其中IPv4的IP头部数据包括：

｜ 4位版本号 | 4位头部长度 | 8位服务类型（TOS） | 16位总长度（字节数） | 16位标识 | 3位标志 | 13位片偏移 | 8位生存时间（TTL） | 8位协议 | 16位头部校验和 | 32位源端IP地址 | 32位目的端IP地址 | 其他选项（最多40字节）|

* 1，版本: IP 协议的版本。通信双方使用过的 P 协议的版本必须一致，目前最广泛使用的 IP 协议版本号为 4(即IPv4)
* 2，首部长度: 单位是 32 位 (4 字节)
* 3，服务类型: 一般不适用，取值为 0
* 4，总长度: 指首部加上数据的总长度，单位为字节
* 5，标识 (identification): IP 软件在存储器中维持一个计数器，每产生一个数据报，计数器就加1，并将此值赋给标识字段
* 6，标志 (flag) : 目前只有两位有意义。
 标志字段中的最低位记为 MF。MF = 1 即表示后面“还有分片”的数据报。MF = 0 表示这已是若干数据报片中的最后一个。标志字段中间的一位记为 DF，意思是”不能分片”，只有当 DF = 0 时才允许分片
* 7，片偏移: 指出较长的分组在分片后，某片在源分组中的相对位置，也就是说，相对于用户数据段的起点，该片从何处开始。片偏移以 8 字节为偏移单位。
* 8，生存时间: TTL，表明是数据报在网络中的寿命，即为“跳数限制”，由发出数据报的源点设置这个字段。路由器在转发数据之前就把 TTL 值减一，当 TTL 值减为零时，就丢弃这个数据报。
* 9，协议: 指出此数据报携带的数据时使用何种协议，以便使目的主机的 IP 层知道应将数据部分上交给哪个处理过程，常用的ICMP(1)，IGMP(2)，TCP(6)，UDP(17)，IPv6(41)
* 10，首部校验和: 只校验数据报的首部，不包括数据部分。
* 11，源地址: 发送方 IP 地址
* 12，目的地址：接收方 IP 地址

## 以太网帧协议


| 目的物理地址（6字节） | 源物理地址（6字节） | 类型（2字节） | 数据（46 ~ 1500字节） | CRC（4字节）|

类型：0X800表示IP、0X806表示ARP、0X835表示RARP

## ARP协议

| 硬件类型（2字节）| 协议类型（2字节）| 硬件地址长度（1字节）| 协议地址长度（1字节）| 操作（2字节）| 发送端以太网地址（6字节）| 发送端IP地址（4字节）| 目的端以太网地址（6字节）| 目的端IP地址（4字节）|

* 1，硬件类型: 1表示MAC
* 2，协议类型: 0x800 表示IP 地址
* 3，硬件地址长度: 6
* 4，协议地址长度: 4
* 5，操作: 1表示 ARP 请求，2表示 ARP 应答，3表示 RARP 请求，4表示R ARP 应答


# 网络通信的过程

## 封装

上层协议是如何使用下层协议提供的服务的呢? 其实这是通过封装(encapsulation)实现的。应用程序数据在发送到物理网络上之前，将沿着协议栈从上往下依次传递。每层协议都将在上层数据的基础上加上自己的头部信息(有时还包括尾部信息)，以实现该层的功能，这个过程就称为封装。

## 分用

当帧到达目的主机时，将沿着协议栈自底向上依次传递。各层协议依次处理帧中本层负责的头部数据，以获取所需的信息，并最终将处理后的交给目标应用程序。这个过程称为分用 (demultiplexing)。分用是依靠头部信息中的类型字段实现的。




